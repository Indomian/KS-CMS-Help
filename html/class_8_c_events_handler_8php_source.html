<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>KS-CMS: Исходный файл modules/main/libs/class.CEventsHandler.php</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Создано системой Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Титульная&nbsp;страница</span></a></li>
      <li><a href="pages.html"><span>Описания</span></a></li>
      <li><a href="namespaces.html"><span>Пространства&nbsp;имен</span></a></li>
      <li><a href="annotated.html"><span>Структуры&nbsp;данных</span></a></li>
      <li class="current"><a href="files.html"><span>Файлы</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Файлы</span></a></li>
      <li><a href="globals.html"><span>Список&nbsp;членов&nbsp;всех&nbsp;файлов</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>modules/main/libs/class.CEventsHandler.php</h1>  </div>
</div>
<div class="contents">
<a href="class_8_c_events_handler_8php.html">См. документацию.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00013"></a>00013  <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;KS_ENGINE&#39;</span>))
<a name="l00014"></a>00014         die(<span class="stringliteral">&quot;Hacking attempt!&quot;</span>);
<a name="l00015"></a>00015  include_once(<span class="stringliteral">&#39;class.CError.php&#39;</span>);                      <span class="comment">// Подключение класса ошибок</span>
<a name="l00016"></a>00016  include_once(<span class="stringliteral">&#39;class.CMain.php&#39;</span>);
<a name="l00017"></a>00017 
<a name="l00028"></a><a class="code" href="class_c_events_handler.html">00028</a>  <span class="keyword">class </span><a class="code" href="class_c_events_handler.html">CEventsHandler</a> <span class="keyword">extends</span> <a class="code" href="class_c_base_object.html">CBaseObject</a>
<a name="l00029"></a>00029  {
<a name="l00030"></a>00030 
<a name="l00036"></a><a class="code" href="class_c_events_handler.html#ae6059ea82d657151d1d5b4f5c5ef9177">00036</a>         <span class="keyword">protected</span> <a class="code" href="class_c_events_handler.html#ae6059ea82d657151d1d5b4f5c5ef9177">$config_file</a>;
<a name="l00037"></a>00037 
<a name="l00054"></a><a class="code" href="class_c_events_handler.html#a1bcec9bbd34255927faaf155bf3a940a">00054</a>         <span class="keyword">protected</span> <a class="code" href="class_c_events_handler.html#a1bcec9bbd34255927faaf155bf3a940a">$events</a>;
<a name="l00055"></a>00055 
<a name="l00065"></a><a class="code" href="class_c_events_handler.html#a7796dad0ff3ac813d513290c9900a763">00065</a>         <span class="keyword">private</span> <a class="code" href="class_c_events_handler.html#a7796dad0ff3ac813d513290c9900a763">$return_type</a>;
<a name="l00066"></a><a class="code" href="class_c_events_handler.html#a6ead9e8a6bc51df0712bc401c049c4d1">00066</a>         <span class="keyword">private</span> <a class="code" href="class_c_events_handler.html#a6ead9e8a6bc51df0712bc401c049c4d1">$arModeStack</a>;
<a name="l00067"></a>00067 
<a name="l00073"></a><a class="code" href="class_c_events_handler.html#a6e8cd923cf7b2e54fce8444387210ea6">00073</a>         <span class="keyword">protected</span> <a class="code" href="class_c_events_handler.html#a6e8cd923cf7b2e54fce8444387210ea6">$actual_module</a>;
<a name="l00074"></a>00074 
<a name="l00080"></a><a class="code" href="class_c_events_handler.html#a8df96a3c2577a10dcec93412d3f9f739">00080</a>         <span class="keyword">protected</span> <a class="code" href="class_c_events_handler.html#a8df96a3c2577a10dcec93412d3f9f739">$actual_event</a>;
<a name="l00081"></a>00081 
<a name="l00087"></a><a class="code" href="class_c_events_handler.html#a496cfb57972da9532fe933ca7db6815e">00087</a>         <span class="keyword">protected</span> <a class="code" href="class_c_events_handler.html#a496cfb57972da9532fe933ca7db6815e">$actual_result</a>;
<a name="l00088"></a>00088 
<a name="l00099"></a><a class="code" href="class_c_events_handler.html#a523e867dbde639f405a0a002342d8f5d">00099</a>         function <a class="code" href="class_c_events_handler.html#a523e867dbde639f405a0a002342d8f5d">__construct</a>(<a class="code" href="class_c_events_handler.html#ae6059ea82d657151d1d5b4f5c5ef9177">$config_file</a>, <a class="code" href="class_c_events_handler.html#a7796dad0ff3ac813d513290c9900a763">$return_type</a> = <span class="stringliteral">&#39;overall&#39;</span>)
<a name="l00100"></a>00100         {
<a name="l00101"></a>00101                 <span class="comment">/* Проверка существования константы пути к модулям */</span>
<a name="l00102"></a>00102                 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;MODULES_DIR&#39;</span>))
<a name="l00103"></a>00103                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;Unspecified constant path to modules&quot;</span>);
<a name="l00104"></a>00104                 $this-&gt;return_type = <a class="code" href="class_c_events_handler.html#a7796dad0ff3ac813d513290c9900a763">$return_type</a>;                      <span class="comment">// Указываем тип данных, возвращаемых методом CEventsHandler::Execute()</span>
<a name="l00105"></a>00105                 <span class="keywordflow">try</span>
<a name="l00106"></a>00106                 {
<a name="l00107"></a>00107                         $this-&gt;<a class="code" href="class_c_events_handler.html#a172e14e421518194c0f232bdc2bd0b9c">LoadFromFile</a>(<a class="code" href="class_c_events_handler.html#ae6059ea82d657151d1d5b4f5c5ef9177">$config_file</a>);
<a name="l00108"></a>00108                 }
<a name="l00109"></a>00109                 <span class="keywordflow">catch</span>(<a class="code" href="class_c_error.html">CError</a> $e)
<a name="l00110"></a>00110                 {
<a name="l00111"></a>00111                         <span class="keywordflow">throw</span> $e;
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113         }
<a name="l00114"></a>00114 
<a name="l00118"></a><a class="code" href="class_c_events_handler.html#a9e5b99f6339426496d66bb73c078cf05">00118</a>         function <a class="code" href="class_c_events_handler.html#a9e5b99f6339426496d66bb73c078cf05">AddEvent</a>(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,$event,$handler)
<a name="l00119"></a>00119         {
<a name="l00120"></a>00120                 $handler[<span class="stringliteral">&#39;hSave&#39;</span>]=<span class="keyword">false</span>;
<a name="l00121"></a>00121                 $this-&gt;events[<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>][$event][]=$handler;
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123 
<a name="l00127"></a><a class="code" href="class_c_events_handler.html#aebec4ed0bff13b50f71198a903d1f683">00127</a>         function <a class="code" href="class_c_events_handler.html#aebec4ed0bff13b50f71198a903d1f683">GetLastEventModule</a>()
<a name="l00128"></a>00128         {
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (strlen($this-&gt;actual_module))
<a name="l00130"></a>00130                         <span class="keywordflow">return</span> $this-&gt;actual_module;
<a name="l00131"></a>00131                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133 
<a name="l00137"></a><a class="code" href="class_c_events_handler.html#a39717c695a573087072b2682a790d2cd">00137</a>         function <a class="code" href="class_c_events_handler.html#a39717c695a573087072b2682a790d2cd">GetLastEvent</a>()
<a name="l00138"></a>00138         {
<a name="l00139"></a>00139                 <span class="keywordflow">if</span> (strlen($this-&gt;actual_event))
<a name="l00140"></a>00140                         <span class="keywordflow">return</span> $this-&gt;actual_event;
<a name="l00141"></a>00141                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143 
<a name="l00147"></a><a class="code" href="class_c_events_handler.html#abde4cf11bbf498878a634a80cd5c8b4a">00147</a>         function <a class="code" href="class_c_events_handler.html#abde4cf11bbf498878a634a80cd5c8b4a">GetLastResult</a>()
<a name="l00148"></a>00148         {
<a name="l00149"></a>00149                 <span class="keywordflow">if</span> (isset($this-&gt;actual_result))
<a name="l00150"></a>00150                         <span class="keywordflow">return</span> $this-&gt;actual_result;
<a name="l00151"></a>00151                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="class_c_events_handler.html#a3fa8ea2a7b1ca8a78d5a83cadeea7852">00154</a>         <span class="keyword">public</span> function <a class="code" href="class_c_events_handler.html#a3fa8ea2a7b1ca8a78d5a83cadeea7852">SetMode</a>($mode)
<a name="l00155"></a>00155         {
<a name="l00156"></a>00156                 <span class="keywordflow">if</span>($mode==<span class="stringliteral">&#39;particular&#39;</span>) $this-&gt;return_type=<span class="stringliteral">&#39;particular&#39;</span>; <span class="keywordflow">else</span> $this-&gt;return_type=<span class="stringliteral">&#39;overall&#39;</span>;
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="class_c_events_handler.html#a010980da56c14a7246491baf8a0a9217">00159</a>         <span class="keyword">public</span> function <a class="code" href="class_c_events_handler.html#a010980da56c14a7246491baf8a0a9217">PushMode</a>()
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161                 array_push($this-&gt;arModeStack,$this-&gt;return_type);
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="class_c_events_handler.html#a00e1bc94eacdb7374d5a075d8ec18628">00164</a>         <span class="keyword">public</span> function <a class="code" href="class_c_events_handler.html#a00e1bc94eacdb7374d5a075d8ec18628">PopMode</a>()
<a name="l00165"></a>00165         {
<a name="l00166"></a>00166                 $this-&gt;return_type=array_pop($this-&gt;arModeStack);
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168 
<a name="l00174"></a><a class="code" href="class_c_events_handler.html#a9244d11ea60c6bc478f7dc0ceab5d02f">00174</a>         <span class="keyword">public</span> function <a class="code" href="class_c_events_handler.html#a9244d11ea60c6bc478f7dc0ceab5d02f">HasHandler</a>(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,$event)
<a name="l00175"></a>00175         {
<a name="l00176"></a>00176                 <span class="keywordflow">if</span>(array_key_exists(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,$this-&gt;events))
<a name="l00177"></a>00177                 {
<a name="l00178"></a>00178                         <span class="keywordflow">if</span>(array_key_exists($event,$this-&gt;events[<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>]))
<a name="l00179"></a>00179                         {
<a name="l00180"></a>00180                                 $arHandlers=$this-&gt;events[$module][$event];
<a name="l00181"></a>00181                                 $bHasFile=<span class="keyword">false</span>;
<a name="l00182"></a>00182                                 $bHasFunc=<span class="keyword">false</span>;
<a name="l00183"></a>00183                                 <span class="keywordflow">foreach</span>($arHandlers as $arHandler)
<a name="l00184"></a>00184                                 {
<a name="l00185"></a>00185                                         <span class="keywordflow">if</span> (isset($arHandler[<span class="stringliteral">&#39;hFile&#39;</span>]) &amp;&amp; $arHandler[<span class="stringliteral">&#39;hFile&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>)
<a name="l00186"></a>00186                                         {
<a name="l00187"></a>00187                                                 <span class="comment">/* Полное имя файла-обработчика */</span>
<a name="l00188"></a>00188                                                 $hFileName = MODULES_DIR . <span class="charliteral">&#39;/&#39;</span> . $this-&gt;actual_module . <span class="stringliteral">&#39;/events/&#39;</span> . $handler[<span class="stringliteral">&#39;hFile&#39;</span>];
<a name="l00189"></a>00189                                                 <span class="keywordflow">if</span> (file_exists($hFileName))
<a name="l00190"></a>00190                                                 {
<a name="l00191"></a>00191                                                         $bHasFile=<span class="keyword">true</span>;
<a name="l00192"></a>00192                                                 }
<a name="l00193"></a>00193                                                 elseif(file_exists($arHandler[<span class="stringliteral">&#39;hFile&#39;</span>]))
<a name="l00194"></a>00194                                                 {
<a name="l00195"></a>00195                                                         $bHasFile=<span class="keyword">true</span>;
<a name="l00196"></a>00196                                                 }
<a name="l00197"></a>00197                                         }
<a name="l00198"></a>00198                                         <span class="comment">/* Указана функция-обработчик */</span>
<a name="l00199"></a>00199                                         <span class="keywordflow">if</span> (isset($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00200"></a>00200                                         {
<a name="l00201"></a>00201                                                 <span class="keywordflow">if</span>(is_array($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00202"></a>00202                                                 {
<a name="l00203"></a>00203                                                         <span class="keywordflow">if</span>(is_object($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00204"></a>00204                                                         {
<a name="l00205"></a>00205                                                                 $bHasFunc = <span class="keyword">true</span>;
<a name="l00206"></a>00206                                                         }
<a name="l00207"></a>00207                                                         elseif(is_string($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00208"></a>00208                                                         {
<a name="l00209"></a>00209                                                                 <span class="keywordflow">if</span>(class_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00210"></a>00210                                                                         <span class="keywordflow">if</span>(method_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0], $handler[<span class="stringliteral">&#39;hFunc&#39;</span>][1]))
<a name="l00211"></a>00211                                                                                 $bHasFunc = <span class="keyword">true</span>;
<a name="l00212"></a>00212                                                         }
<a name="l00213"></a>00213                                                 }
<a name="l00214"></a>00214                                                 elseif (function_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00215"></a>00215                                                 {
<a name="l00216"></a>00216                                                         $bHasFunc = <span class="keyword">true</span>;
<a name="l00217"></a>00217                                                 }
<a name="l00218"></a>00218                                         }
<a name="l00219"></a>00219                                         <span class="keywordflow">if</span>($bHasFile || $bHasFunc) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00220"></a>00220                                 }
<a name="l00221"></a>00221                         }
<a name="l00222"></a>00222                 }
<a name="l00223"></a>00223                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225 
<a name="l00240"></a><a class="code" href="class_c_events_handler.html#a94e0d109f12220905591f0b344bda8fd">00240</a>         function <a class="code" href="class_c_events_handler.html#a94e0d109f12220905591f0b344bda8fd">Execute</a>($moduleName, $onEvent, &amp;$hParams = <span class="keyword">false</span>)
<a name="l00241"></a>00241         {
<a name="l00242"></a>00242                 <span class="comment">/* Установка имён модуля и события, с которыми будет производиться работа</span>
<a name="l00243"></a>00243 <span class="comment">                   После выполнения обработчиков по этим полям можно будет узнать последний модуль и последнее событие */</span>
<a name="l00244"></a>00244                 $this-&gt;actual_module = $moduleName;
<a name="l00245"></a>00245                 $this-&gt;actual_event = $onEvent;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247                 <span class="comment">/* Формирование массива с параметрами обработчиков и результатами их выполнения</span>
<a name="l00248"></a>00248 <span class="comment">                   Каждый элемент массива представляет собой массив со следующими возможными ключам:</span>
<a name="l00249"></a>00249 <span class="comment">                   &#39;hFile&#39; (имя файла-обработчика);</span>
<a name="l00250"></a>00250 <span class="comment">                   &#39;hFunc&#39; (имя функции-обработчика);</span>
<a name="l00251"></a>00251 <span class="comment">                   &#39;executed&#39; */</span>
<a name="l00252"></a>00252                 $handlers = array();
<a name="l00253"></a>00253                 <span class="comment">/* Поиск и выполнение соответствующих событию файлов-обработчиков и/или функций-обработчиков для данного модуля */</span>
<a name="l00254"></a>00254                 <span class="keywordflow">if</span> (isset($this-&gt;events[$this-&gt;actual_module]))
<a name="l00255"></a>00255                         <span class="keywordflow">if</span> (isset($this-&gt;events[$this-&gt;actual_module][$this-&gt;actual_event]))
<a name="l00256"></a>00256                         {
<a name="l00257"></a>00257                                 $handlers = $this-&gt;events[$this-&gt;actual_module][$this-&gt;actual_event];
<a name="l00258"></a>00258                                 <span class="keywordflow">if</span> (is_array($handlers))
<a name="l00259"></a>00259                                         <span class="keywordflow">if</span> (count($handlers))
<a name="l00260"></a>00260                                                 <span class="keywordflow">foreach</span> ($handlers as $handlerKey =&gt; $handler)
<a name="l00261"></a>00261                                                 {
<a name="l00262"></a>00262                                                         <span class="comment">/*Проверяем выполнять обработку один раз или много*/</span>
<a name="l00263"></a>00263                                                         <span class="keywordflow">if</span>($handler[<span class="stringliteral">&#39;bOnce&#39;</span>]==<span class="keyword">true</span>)
<a name="l00264"></a>00264                                                         {
<a name="l00265"></a>00265                                                                 unset($this-&gt;events[$this-&gt;actual_module][$this-&gt;actual_event][$handlerKey]);
<a name="l00266"></a>00266                                                         }
<a name="l00267"></a>00267                                                         <span class="comment">/* Если функция-обработчик задана и существует, то она выполняется,</span>
<a name="l00268"></a>00268 <span class="comment">                                                           и результатом её работы должна быть переменная типа boolean.</span>
<a name="l00269"></a>00269 <span class="comment">                                                           Если же функция-обработчик не задана, то переменная типа boolean должна быть</span>
<a name="l00270"></a>00270 <span class="comment">                                                           определена с именем $hResult самим файлом-обработчиком</span>
<a name="l00271"></a>00271 <span class="comment">                                                           Для возвращения конкретных данных можно использовать массив $hParams,</span>
<a name="l00272"></a>00272 <span class="comment">                                                           который передаётся по ссылке */</span>
<a name="l00273"></a>00273                                                         $handlers[$handlerKey][<span class="stringliteral">&#39;executed&#39;</span>] = <span class="keyword">false</span>;             <span class="comment">// 1, если обработчик успешно выполнен</span>
<a name="l00274"></a>00274                                                         <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = <span class="keyword">false</span>;
<a name="l00275"></a>00275                                                         $hFileExists = <span class="keyword">false</span>;
<a name="l00276"></a>00276                                                         $hFuncExists = <span class="keyword">false</span>;
<a name="l00277"></a>00277                                                         <span class="comment">/* Указан файл-обработчик */</span>
<a name="l00278"></a>00278                                                         <span class="keywordflow">if</span> (isset($handler[<span class="stringliteral">&#39;hFile&#39;</span>]))
<a name="l00279"></a>00279                                                         {
<a name="l00280"></a>00280                                                                 <span class="keywordflow">if</span> (strlen($handler[<span class="stringliteral">&#39;hFile&#39;</span>]))
<a name="l00281"></a>00281                                                                 {
<a name="l00282"></a>00282                                                                         <span class="comment">/* Полное имя файла-обработчика */</span>
<a name="l00283"></a>00283                                                                         $hFileName = MODULES_DIR . <span class="charliteral">&#39;/&#39;</span> . $this-&gt;actual_module . <span class="stringliteral">&#39;/events/&#39;</span> . $handler[<span class="stringliteral">&#39;hFile&#39;</span>];
<a name="l00284"></a>00284                                                                         <span class="keywordflow">if</span> (file_exists($hFileName))
<a name="l00285"></a>00285                                                                         {
<a name="l00286"></a>00286                                                                                 $hFileExists = <span class="keyword">true</span>;
<a name="l00287"></a>00287                                                                                 include_once($hFileName);       <span class="comment">// Подключаем файл-обработчик, если не был подключен ранее</span>
<a name="l00288"></a>00288                                                                         }
<a name="l00289"></a>00289                                                                         elseif(file_exists($handler[<span class="stringliteral">&#39;hFile&#39;</span>]))
<a name="l00290"></a>00290                                                                         {
<a name="l00291"></a>00291                                                                                 $hFileExists = <span class="keyword">true</span>;
<a name="l00292"></a>00292                                                                                 include_once($handler[<span class="stringliteral">&#39;hFile&#39;</span>]);        <span class="comment">// Подключаем файл-обработчик, если не был подключен ранее</span>
<a name="l00293"></a>00293                                                                         }
<a name="l00294"></a>00294                                                                 }
<a name="l00295"></a>00295                                                         }
<a name="l00296"></a>00296                                                         <span class="comment">/* Указана функция-обработчик */</span>
<a name="l00297"></a>00297                                                         <span class="keywordflow">if</span> (isset($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00298"></a>00298                                                         {
<a name="l00299"></a>00299                                                                 <span class="keywordflow">if</span>(is_array($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00300"></a>00300                                                                 {
<a name="l00301"></a>00301                                                                         <span class="keywordflow">if</span>(is_object($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00302"></a>00302                                                                         {
<a name="l00303"></a>00303                                                                                 $hFuncExists = <span class="keyword">true</span>;
<a name="l00304"></a>00304                                                                         }
<a name="l00305"></a>00305                                                                         elseif(is_string($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00306"></a>00306                                                                         {
<a name="l00307"></a>00307                                                                                 <span class="keywordflow">if</span>(class_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0]))
<a name="l00308"></a>00308                                                                                         <span class="keywordflow">if</span>(method_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>][0], $handler[<span class="stringliteral">&#39;hFunc&#39;</span>][1]))
<a name="l00309"></a>00309                                                                                                 $hFuncExists = <span class="keyword">true</span>;
<a name="l00310"></a>00310                                                                         }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312                                                                         <span class="keywordflow">if</span>($hFuncExists)
<a name="l00313"></a>00313                                                                         {
<a name="l00314"></a>00314                                                                                 <span class="keywordflow">if</span> (!is_array($hParams) &amp;&amp; !$hParams)
<a name="l00315"></a>00315                                                                                         <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]);
<a name="l00316"></a>00316                                                                                 elseif(!is_array($handler[<span class="stringliteral">&#39;arParams&#39;</span>]))
<a name="l00317"></a>00317                                                                                         <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>], &amp;$hParams);
<a name="l00318"></a>00318                                                                                 <span class="keywordflow">else</span>
<a name="l00319"></a>00319                                                                                         <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>], &amp;$hParams,$handler[<span class="stringliteral">&#39;arParams&#39;</span>]);
<a name="l00320"></a>00320                                                                         }
<a name="l00321"></a>00321                                                                 }
<a name="l00322"></a>00322                                                                 elseif (function_exists($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00323"></a>00323                                                                 {
<a name="l00324"></a>00324                                                                         $hFuncExists = <span class="keyword">true</span>;
<a name="l00325"></a>00325                                                                         <span class="keywordflow">if</span> (!is_array($hParams) &amp;&amp; !$hParams)
<a name="l00326"></a>00326                                                                                 <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>]);
<a name="l00327"></a>00327                                                                         elseif(!is_array($handler[<span class="stringliteral">&#39;arParams&#39;</span>]))
<a name="l00328"></a>00328                                                                                 <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>], &amp;$hParams);
<a name="l00329"></a>00329                                                                         <span class="keywordflow">else</span>
<a name="l00330"></a>00330                                                                                 <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = call_user_func($handler[<span class="stringliteral">&#39;hFunc&#39;</span>], &amp;$hParams,$handler[<span class="stringliteral">&#39;arParams&#39;</span>]);
<a name="l00331"></a>00331                                                                 }
<a name="l00332"></a>00332                                                         }
<a name="l00333"></a>00333                                                         <span class="comment">/* Если обработчик не был задан, то метод должен вернуть корректный результат */</span>
<a name="l00334"></a>00334                                                         <span class="keywordflow">if</span> (!$hFileExists &amp;&amp; !$hFuncExists)
<a name="l00335"></a>00335                                                         {
<a name="l00336"></a>00336                                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;SYSTEM_HANDLER_NOT_FOUND&#39;</span>,1,(is_array($handler[<span class="stringliteral">&#39;hFunc&#39;</span>])?join(<span class="charliteral">&#39;:&#39;</span>,$handler[<span class="stringliteral">&#39;hFunc&#39;</span>]):$handler[<span class="stringliteral">&#39;hFunc&#39;</span>]).($handler[<span class="stringliteral">&#39;hFile&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>?$handler[<span class="stringliteral">&#39;hFile&#39;</span>]:<span class="stringliteral">&#39;&#39;</span>));
<a name="l00337"></a>00337                                                                 <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a> = <span class="keyword">true</span>;
<a name="l00338"></a>00338                                                         }
<a name="l00339"></a>00339                                                         <span class="comment">/* Проверка правильности результата выполнения файла-обработчика или функции-обработчика */</span>
<a name="l00340"></a>00340                                                         <span class="keywordflow">if</span> (<a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a>&gt;0)
<a name="l00341"></a>00341                                                                 $handlers[$handlerKey][<span class="stringliteral">&#39;executed&#39;</span>] = <a class="code" href="on_init_8php.html#a4f30ecbf438beab793443519539d8805">$hResult</a>;
<a name="l00342"></a>00342                                                 }
<a name="l00343"></a>00343                         }
<a name="l00344"></a>00344                 <span class="comment">/* В зависимости от установленного типа возвращаемого результата формируем выходные данные */</span>
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> ($this-&gt;return_type === <span class="stringliteral">&#39;particular&#39;</span>)
<a name="l00346"></a>00346                 {
<a name="l00347"></a>00347                         $this-&gt;actual_result = $handlers;
<a name="l00348"></a>00348                         <span class="keywordflow">return</span> $this-&gt;actual_result;
<a name="l00349"></a>00349                 }
<a name="l00350"></a>00350                 <span class="keywordflow">if</span> (count($handlers))
<a name="l00351"></a>00351                 {
<a name="l00352"></a>00352                         $execResult = <span class="keyword">true</span>;             <span class="comment">// Общий результат выполнения всех обработчиков события</span>
<a name="l00353"></a>00353                         <span class="keywordflow">foreach</span> ($handlers as $handlerKey =&gt; $handler)
<a name="l00354"></a>00354                                 $execResult *= $handler[<span class="stringliteral">&#39;executed&#39;</span>];
<a name="l00355"></a>00355                         $this-&gt;actual_result = $execResult;
<a name="l00356"></a>00356                         <span class="keywordflow">return</span> $this-&gt;actual_result;
<a name="l00357"></a>00357                 }
<a name="l00358"></a>00358                 <span class="comment">/* Для данного модуля не найдено ни одного обработчика */</span>
<a name="l00359"></a>00359                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361 
<a name="l00365"></a><a class="code" href="class_c_events_handler.html#a172e14e421518194c0f232bdc2bd0b9c">00365</a>         function <a class="code" href="class_c_events_handler.html#a172e14e421518194c0f232bdc2bd0b9c">LoadFromFile</a>($filename=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00366"></a>00366         {
<a name="l00367"></a>00367                 $this-&gt;config_file = $filename;                 <span class="comment">// Устанавливаем имя конфигурационного файла</span>
<a name="l00368"></a>00368                 <span class="keywordflow">if</span> (!file_exists($this-&gt;config_file))
<a name="l00369"></a>00369                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;SYSTEM_CONFIG_NOT_FOUND&quot;</span>, 0, $this-&gt;config_file);
<a name="l00370"></a>00370                 include_once($this-&gt;config_file);                       <span class="comment">// Попытка подключения конфигурационного файла</span>
<a name="l00371"></a>00371                 <span class="comment">/* Проверка существования конфигурационного массива */</span>
<a name="l00372"></a>00372                 <span class="keywordflow">if</span> (isset(<a class="code" href="events_8php.html#a71f6ccf8aa84906e421092dce78ea81f">$KS_EVENTS</a>))
<a name="l00373"></a>00373                         <span class="keywordflow">if</span> (is_array(<a class="code" href="events_8php.html#a71f6ccf8aa84906e421092dce78ea81f">$KS_EVENTS</a>))
<a name="l00374"></a>00374                         {
<a name="l00375"></a>00375                                 $this-&gt;events = <a class="code" href="events_8php.html#a71f6ccf8aa84906e421092dce78ea81f">$KS_EVENTS</a>;             <span class="comment">// Установка поля конфигурационного массива</span>
<a name="l00376"></a>00376                                 $this-&gt;actual_module = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00377"></a>00377                                 $this-&gt;actual_event = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00378"></a>00378                                 $this-&gt;actual_result = null;
<a name="l00379"></a>00379                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00380"></a>00380                         }
<a name="l00381"></a>00381                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383 
<a name="l00388"></a><a class="code" href="class_c_events_handler.html#af1ca2a65a82164db492d9fa865389aa4">00388</a>         function <a class="code" href="class_c_events_handler.html#af1ca2a65a82164db492d9fa865389aa4">SaveToFile</a>($filename=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00389"></a>00389         {
<a name="l00390"></a>00390                 <span class="keywordflow">if</span>($filename==<span class="stringliteral">&#39;&#39;</span>)
<a name="l00391"></a>00391                 {
<a name="l00392"></a>00392                         $filename=CONFIG_DIR.<span class="stringliteral">&#39;/events_config.php&#39;</span>;
<a name="l00393"></a>00393                 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                 $sFilecontent=<span class="stringliteral">&quot;&lt;?php\n&quot;</span>.
<a name="l00396"></a>00396                 <span class="stringliteral">&quot;\n/**</span>
<a name="l00397"></a>00397 <span class="stringliteral">                         * Конфигурационный файл обработчиков событий</span>
<a name="l00398"></a>00398 <span class="stringliteral">                        *</span>
<a name="l00399"></a>00399 <span class="stringliteral">                        * В этом файле должен быть определён конфигурационный массив обработчиков событий $KS_EVENTS,</span>
<a name="l00400"></a>00400 <span class="stringliteral">                        * структура которого описана в классе CEventsHandler</span>
<a name="l00401"></a>00401 <span class="stringliteral">                        *</span>
<a name="l00402"></a>00402 <span class="stringliteral">                        * @filesource events_config.php</span>
<a name="l00403"></a>00403 <span class="stringliteral">                        * @author north-e &lt;pushkov@kolosstudio.ru&gt;</span>
<a name="l00404"></a>00404 <span class="stringliteral">                        * @version 0.1</span>
<a name="l00405"></a>00405 <span class="stringliteral">                        * @since 03.03.2009</span>
<a name="l00406"></a>00406 <span class="stringliteral">                        * Файл сгенерирован автоматически</span>
<a name="l00407"></a>00407 <span class="stringliteral">                        */\n&quot;</span>.
<a name="l00408"></a>00408                 <span class="stringliteral">&#39;$KS_EVENTS = array&#39;</span>.<span class="stringliteral">&quot;\n(\n&quot;</span>;
<a name="l00409"></a>00409                 <span class="keywordflow">foreach</span>($this-&gt;events as <a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>=&gt;$arEvents)
<a name="l00410"></a>00410                 {
<a name="l00411"></a>00411                         $sFilecontent.=<span class="stringliteral">&quot;&#39;$module&#39;=&gt;array\n(\n&quot;</span>;
<a name="l00412"></a>00412                         <span class="keywordflow">foreach</span>($arEvents as $sEvent=&gt;$arActions)
<a name="l00413"></a>00413                         {
<a name="l00414"></a>00414                                 $sFilecontent.=<span class="stringliteral">&quot;&#39;$sEvent&#39;=&gt;array\n(\n&quot;</span>;
<a name="l00415"></a>00415                                 $arWasActions=array();
<a name="l00416"></a>00416                                 <span class="keywordflow">foreach</span>($arActions as $arAction)
<a name="l00417"></a>00417                                 {
<a name="l00418"></a>00418                                         <span class="keywordflow">if</span>(!array_key_exists(<span class="stringliteral">&#39;hSave&#39;</span>,$arAction)&amp;&amp;!$arAction[<span class="stringliteral">&#39;bOnce&#39;</span>]&amp;&amp;(!in_array($arAction,$arWasActions)))
<a name="l00419"></a>00419                                         {
<a name="l00420"></a>00420                                                 $sFilecontent.=<span class="stringliteral">&quot;array(&#39;hFile&#39;=&gt;&#39;&quot;</span>.$arAction[<span class="stringliteral">&#39;hFile&#39;</span>].<span class="stringliteral">&quot;&#39;,&#39;hFunc&#39;=&gt;&quot;</span>;
<a name="l00421"></a>00421                                                 <span class="keywordflow">if</span>(is_array($arAction[<span class="stringliteral">&#39;hFunc&#39;</span>]))
<a name="l00422"></a>00422                                                 {
<a name="l00423"></a>00423                                                         $sFilecontent.=<span class="stringliteral">&quot;array(&#39;&quot;</span>.$arAction[<span class="stringliteral">&#39;hFunc&#39;</span>][0].<span class="stringliteral">&quot;&#39;,&#39;&quot;</span>.$arAction[<span class="stringliteral">&#39;hFunc&#39;</span>][1].<span class="stringliteral">&quot;&#39;)&quot;</span>;
<a name="l00424"></a>00424                                                 }
<a name="l00425"></a>00425                                                 <span class="keywordflow">else</span>
<a name="l00426"></a>00426                                                 {
<a name="l00427"></a>00427                                                         $sFilecontent.=<span class="stringliteral">&quot;&#39;&quot;</span>.$arAction[<span class="stringliteral">&#39;hFunc&#39;</span>].<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00428"></a>00428                                                 }
<a name="l00429"></a>00429                                                 $sFilecontent.=<span class="stringliteral">&quot;),\n&quot;</span>;
<a name="l00430"></a>00430                                                 $arWasActions[]=$arAction;
<a name="l00431"></a>00431                                         }
<a name="l00432"></a>00432                                 }
<a name="l00433"></a>00433                                 $sFilecontent.=<span class="stringliteral">&quot;\n),\n&quot;</span>;
<a name="l00434"></a>00434                         }
<a name="l00435"></a>00435                         $sFilecontent.=<span class="stringliteral">&quot;\n),\n&quot;</span>;
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437                 $sFilecontent.=<span class="stringliteral">&quot;);?&gt;&quot;</span>;
<a name="l00438"></a>00438                 <span class="keywordflow">return</span> file_put_contents($filename,$sFilecontent);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="class_c_events_handler.html#a9a8fd200f775b3a2671354468dcc96eb">00441</a>         function <a class="code" href="class_c_events_handler.html#a9a8fd200f775b3a2671354468dcc96eb">AddStaticEvent</a>(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,$event,$arParams)
<a name="l00442"></a>00442         {
<a name="l00443"></a>00443                 <span class="comment">//$arParams[&#39;hSave&#39;]=true;</span>
<a name="l00444"></a>00444                 $this-&gt;events[<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>][$event][]=$arParams;
<a name="l00445"></a>00445         }
<a name="l00446"></a>00446  }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 ?&gt;
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Документация по KS-CMS. Последние изменения: Wed Mar 2 2011 17:46:18. Создано системой&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
