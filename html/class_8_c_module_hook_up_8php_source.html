<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>KS-CMS: Исходный файл modules/main/libs/class.CModuleHookUp.php</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Создано системой Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Титульная&nbsp;страница</span></a></li>
      <li><a href="pages.html"><span>Описания</span></a></li>
      <li><a href="namespaces.html"><span>Пространства&nbsp;имен</span></a></li>
      <li><a href="annotated.html"><span>Структуры&nbsp;данных</span></a></li>
      <li class="current"><a href="files.html"><span>Файлы</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Файлы</span></a></li>
      <li><a href="globals.html"><span>Список&nbsp;членов&nbsp;всех&nbsp;файлов</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>modules/main/libs/class.CModuleHookUp.php</h1>  </div>
</div>
<div class="contents">
<a href="class_8_c_module_hook_up_8php.html">См. документацию.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a><a class="code" href="class_8_c_module_hook_up_8php.html#aa2751051afe353ae55a548bdc2a59679">00002</a> <span class="keywordflow">if</span>( !defined(<span class="stringliteral">&#39;KS_ENGINE&#39;</span>) ) {die(<span class="stringliteral">&quot;Hacking attempt!&quot;</span>);}
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 include_once MODULES_DIR.<span class="stringliteral">&#39;/main/libs/class.CModuleManagment.php&#39;</span>;
<a name="l00005"></a>00005 
<a name="l00010"></a><a class="code" href="class_c_module_hook_up.html">00010</a> <span class="keyword">class </span><a class="code" href="class_c_module_hook_up.html">CModuleHookUp</a> <span class="keyword">extends</span> <a class="code" href="class_c_module_managment.html">CModuleManagment</a>
<a name="l00011"></a>00011 {
<a name="l00012"></a><a class="code" href="class_c_module_hook_up.html#a8667c2de0602486507af4cd36bf4ec0e">00012</a>         <span class="keyword">protected</span> <a class="code" href="class_c_module_hook_up.html#a8667c2de0602486507af4cd36bf4ec0e">$arWidgetStack</a>;
<a name="l00013"></a><a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">00013</a>         <span class="keyword">protected</span> <a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>;
<a name="l00014"></a><a class="code" href="class_c_module_hook_up.html#aca2cc63db9060c21b0df9d14eb62a7ad">00014</a>         <span class="keyword">protected</span> <a class="code" href="class_c_module_hook_up.html#aca2cc63db9060c21b0df9d14eb62a7ad">$sScheme</a>;
<a name="l00015"></a><a class="code" href="class_c_module_hook_up.html#a34b9927935849a862f10e0fc5c2a4942">00015</a>         <span class="keyword">protected</span> <a class="code" href="class_c_module_hook_up.html#a34b9927935849a862f10e0fc5c2a4942">$arWidgetTimes</a>;
<a name="l00016"></a><a class="code" href="class_c_module_hook_up.html#ad9d7ce33ebb142b70e58b68052ca0ea8">00016</a>         <span class="keyword">static</span> <span class="keyword">private</span> <a class="code" href="class_c_module_hook_up.html#ad9d7ce33ebb142b70e58b68052ca0ea8">$instance</a>;
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="class_c_module_hook_up.html#a1f1138b29169d42a9be281c75dac1214">00018</a>         function <a class="code" href="class_c_module_managment.html#a095c5d389db211932136b53f25f39685">__construct</a>(<a class="code" href="class_c_object.html#a6b7d3b9c752a0c977de5ddae78b522a9">$sTable</a>=<span class="stringliteral">&#39;main_modules&#39;</span>)
<a name="l00019"></a>00019         {
<a name="l00020"></a>00020                 <a class="code" href="class_c_module_managment.html#a095c5d389db211932136b53f25f39685">parent::__construct</a>(<a class="code" href="class_c_object.html#a6b7d3b9c752a0c977de5ddae78b522a9">$sTable</a>);
<a name="l00021"></a>00021         }
<a name="l00022"></a>00022 
<a name="l00026"></a><a class="code" href="class_c_module_hook_up.html#a4be4055f3361d4800e16bc2e2e38cda6">00026</a>         <span class="keyword">private</span> function <a class="code" href="class_c_module_hook_up.html#a4be4055f3361d4800e16bc2e2e38cda6">init</a>()
<a name="l00027"></a>00027         {
<a name="l00028"></a>00028                 global <a class="code" href="catsubcat_2main_8inc_8php.html#a2f565251ad8386454acdab24fc7244e4">$KS_IND_matches</a>;
<a name="l00029"></a>00029                 $this-&gt;arWidgetStack=array();
<a name="l00030"></a>00030                 $this-&gt;sTemplate=<span class="stringliteral">&#39;.default&#39;</span>;
<a name="l00031"></a>00031                 $this-&gt;sScheme=<span class="stringliteral">&#39;index&#39;</span>;
<a name="l00032"></a>00032                 <span class="keywordflow">if</span>(<a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>=$this-&gt;<a class="code" href="class_c_module_managment.html#a36b62ef42e3642f437b291cc64bcb817">select_global_template</a>($KS_IND_matches[0]))
<a name="l00033"></a>00033                 {
<a name="l00034"></a>00034                         $arTemplate=explode(<span class="charliteral">&#39;:&#39;</span>,<a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>);
<a name="l00035"></a>00035                         <span class="keywordflow">if</span>(is_array($arTemplate)&amp;&amp;count($arTemplate)&gt;1)
<a name="l00036"></a>00036                         {
<a name="l00037"></a>00037                                 $this-&gt;sTemplate=$arTemplate[0];
<a name="l00038"></a>00038                                 $this-&gt;sScheme=$arTemplate[1];
<a name="l00039"></a>00039                         }
<a name="l00040"></a>00040                 }
<a name="l00041"></a>00041         }
<a name="l00042"></a>00042 
<a name="l00048"></a><a class="code" href="class_c_module_hook_up.html#aeeb76432d095288ac056df22cca56d16">00048</a>         <span class="keyword">static</span> function <a class="code" href="class_c_module_hook_up.html#aeeb76432d095288ac056df22cca56d16">get_instance</a>()
<a name="l00049"></a>00049         {
<a name="l00050"></a>00050             <span class="keywordflow">if</span> (!self::$instance)
<a name="l00051"></a>00051             {
<a name="l00052"></a>00052                 self::$instance = <span class="keyword">new</span> <a class="code" href="class_c_module_hook_up.html">CModuleHookUp</a>();
<a name="l00053"></a>00053                 self::$instance-&gt;init();  <span class="comment">// init AFTER object was linked with self::$instance</span>
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055             <span class="keywordflow">return</span> self::$instance;
<a name="l00056"></a>00056         }
<a name="l00057"></a>00057 
<a name="l00061"></a><a class="code" href="class_c_module_hook_up.html#abed0d43386ff75654371e4c0150441f0">00061</a>         function <a class="code" href="class_c_module_hook_up.html#abed0d43386ff75654371e4c0150441f0">GetWidgetTimes</a>()
<a name="l00062"></a>00062         {
<a name="l00063"></a>00063                 <span class="keywordflow">return</span> $this-&gt;arWidgetTimes;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="class_c_module_hook_up.html#a57bb4ec19d21f1a1205c871020c7af73">00066</a>         function <a class="code" href="class_c_module_hook_up.html#a57bb4ec19d21f1a1205c871020c7af73">AddToLog</a>($widget,$time)
<a name="l00067"></a>00067         {
<a name="l00068"></a>00068                 <span class="keywordflow">if</span>(KS_DEBUG==1)
<a name="l00069"></a>00069                 {
<a name="l00070"></a>00070                         $this-&gt;arWidgetTimes[]=array(<span class="stringliteral">&#39;name&#39;</span>=&gt;$widget,<span class="stringliteral">&#39;time&#39;</span>=&gt;$time,<span class="stringliteral">&#39;level&#39;</span>=&gt;count($this-&gt;arWidgetStack));
<a name="l00071"></a>00071                 }
<a name="l00072"></a>00072         }
<a name="l00073"></a>00073 
<a name="l00079"></a><a class="code" href="class_c_module_hook_up.html#a2956153a176c9e8b2ed24489c3730280">00079</a>         function <a class="code" href="class_c_module_hook_up.html#a2956153a176c9e8b2ed24489c3730280">InitModule</a>(<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>)
<a name="l00080"></a>00080         {
<a name="l00081"></a>00081                 global <a class="code" href="catsubcat_2install_2install_8php.html#afc7cd28698e72d5bc152e5d74de0f54d">$ks_db</a>;
<a name="l00082"></a>00082                 <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>=array(<span class="stringliteral">&#39;active&#39;</span>=&gt;<span class="charliteral">&#39;0&#39;</span>);
<a name="l00083"></a>00083                 <span class="comment">//Смотрим какой первый параметр, если строка - ищем такой модуль</span>
<a name="l00084"></a>00084                 <span class="keywordflow">if</span>(is_string(<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>))
<a name="l00085"></a>00085                 {
<a name="l00086"></a>00086                         <span class="keywordflow">if</span> (array_key_exists(<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>, $this-&gt;arModules)) <span class="keywordflow">return</span> $this-&gt;arModules;
<a name="l00087"></a>00087                         <span class="keywordflow">if</span>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>=$this-&gt;<a class="code" href="class_c_object.html#aaa7edf39bf09d230ec2b32b95c138a9b">GetRecord</a>(array(<span class="stringliteral">&#39;active&#39;</span>=&gt;1,<span class="stringliteral">&#39;directory&#39;</span>=&gt;<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>)))
<a name="l00088"></a>00088                                 $this-&gt;arModules[<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>] = <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>;
<a name="l00089"></a>00089                         <span class="keywordflow">else</span>
<a name="l00090"></a>00090                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00091"></a>00091                 }
<a name="l00092"></a>00092                 <span class="comment">//если массив, считаем что  это описание модуля</span>
<a name="l00093"></a>00093                 elseif(is_array(<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>))
<a name="l00094"></a>00094                 {
<a name="l00095"></a>00095                         <span class="keywordflow">if</span> (array_key_exists(<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>[<span class="stringliteral">&#39;directory&#39;</span>], $this-&gt;arModules)) <span class="keywordflow">return</span> $this-&gt;arModules;
<a name="l00096"></a>00096                         $this-&gt;arModules[<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>[<span class="stringliteral">&#39;directory&#39;</span>]]=$module_name;
<a name="l00097"></a>00097                         $module_name=$module_name[<span class="stringliteral">&#39;directory&#39;</span>];
<a name="l00098"></a>00098                 }
<a name="l00099"></a>00099                 <span class="keywordflow">else</span>
<a name="l00100"></a>00100                 {
<a name="l00101"></a>00101                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00102"></a>00102                 }
<a name="l00103"></a>00103                 <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>=$this-&gt;arModules[<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>];
<a name="l00104"></a>00104                 <span class="keywordflow">if</span>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;active&#39;</span>]==1)
<a name="l00105"></a>00105                 {
<a name="l00106"></a>00106                         <span class="comment">/* Подключение конфигурационного файла */</span>
<a name="l00107"></a>00107                         $module_config_file = MODULES_DIR . <span class="stringliteral">&quot;/&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>] . <span class="stringliteral">&quot;/config.php&quot;</span>;
<a name="l00108"></a>00108                         <span class="keywordflow">if</span> (file_exists($module_config_file))
<a name="l00109"></a>00109                         {
<a name="l00110"></a>00110                                 <span class="comment">/* Чтение конфигурационных массивов */</span>
<a name="l00111"></a>00111                                 include($module_config_file);
<a name="l00112"></a>00112                                 $config_var = <span class="stringliteral">&quot;MODULE_&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>] . <span class="stringliteral">&quot;_config&quot;</span>;
<a name="l00113"></a>00113                                 $db_config_var = <span class="stringliteral">&quot;MODULE_&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>] . <span class="stringliteral">&quot;_db_config&quot;</span>;
<a name="l00114"></a>00114                                 <span class="keywordflow">if</span> (isset($$config_var))
<a name="l00115"></a>00115                                         <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;config&#39;</span>] = $$config_var;
<a name="l00116"></a>00116                                 <span class="keywordflow">if</span> (isset($$db_config_var))
<a name="l00117"></a>00117                                         <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;db_config&#39;</span>] = $$db_config_var;
<a name="l00118"></a>00118                         }
<a name="l00119"></a>00119                         <span class="keywordflow">if</span>(file_exists(MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/init.inc.php&#39;</span>))
<a name="l00120"></a>00120                         {
<a name="l00121"></a>00121                                 include_once MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/init.inc.php&#39;</span>;
<a name="l00122"></a>00122                         }
<a name="l00123"></a>00123                         <span class="keywordflow">if</span>(file_exists(MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/main.init.php&#39;</span>))
<a name="l00124"></a>00124                         {
<a name="l00125"></a>00125                                 include_once MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/main.init.php&#39;</span>;
<a name="l00126"></a>00126                         }
<a name="l00127"></a>00127                         $this-&gt;arModules[<a class="code" href="catsubcat_2admin_8init_8php.html#a68b641f7e74c6ab83515f2428072637d">$module_name</a>]=<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>;
<a name="l00128"></a>00128                         <span class="keywordflow">return</span> $this-&gt;arModules;
<a name="l00129"></a>00129                 }
<a name="l00130"></a>00130                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132 
<a name="l00145"></a><a class="code" href="class_c_module_hook_up.html#a3729046d08c260692b7824af268e6fa7">00145</a>         function <a class="code" href="class_c_module_hook_up.html#a3729046d08c260692b7824af268e6fa7">IncludeModule</a>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>,&amp;<a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>)
<a name="l00146"></a>00146         {
<a name="l00147"></a>00147                 global <a class="code" href="smilies_8php.html#a17f6eca81ab87d6a14c25002c2d946e8">$KS_URL</a>;
<a name="l00148"></a>00148                 <span class="keywordflow">if</span>(!array_key_exists(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>],$this-&gt;arModules))
<a name="l00149"></a>00149                 {
<a name="l00150"></a>00150                         $this-&gt;<a class="code" href="class_c_module_hook_up.html#a2956153a176c9e8b2ed24489c3730280">InitModule</a>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>);
<a name="l00151"></a>00151                 }
<a name="l00152"></a>00152                 <span class="keywordflow">if</span>(file_exists(MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/main.inc.php&#39;</span>) )
<a name="l00153"></a>00153                 {
<a name="l00154"></a>00154                         $module_main_file = MODULES_DIR . <span class="stringliteral">&quot;/&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>] . <span class="stringliteral">&quot;/main.inc.php&quot;</span>;
<a name="l00155"></a>00155                         <span class="keywordflow">if</span>(array_key_exists(<span class="stringliteral">&#39;fromsearch&#39;</span>,$_GET)&amp;&amp;($_GET[<span class="stringliteral">&#39;fromsearch&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>))
<a name="l00156"></a>00156                         {
<a name="l00157"></a>00157                                 $module_search_file = MODULES_DIR . <span class="stringliteral">&quot;/&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>] . <span class="stringliteral">&quot;/search.inc.php&quot;</span>;
<a name="l00158"></a>00158                                 <span class="keywordflow">if</span> (file_exists($module_search_file))
<a name="l00159"></a>00159                                 {
<a name="l00160"></a>00160                                         $hash = $_GET[<span class="stringliteral">&#39;fromsearch&#39;</span>];
<a name="l00161"></a>00161                                         include ($module_search_file);
<a name="l00162"></a>00162                                 }
<a name="l00163"></a>00163                                 <span class="keywordflow">else</span>
<a name="l00164"></a>00164                                 {
<a name="l00165"></a>00165                                         <span class="keywordflow">if</span> (<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;URL_ident&#39;</span>] == <span class="stringliteral">&quot;default&quot;</span>)
<a name="l00166"></a>00166                                                 $KS_URL-&gt;redirect(<span class="stringliteral">&quot;/&quot;</span>);
<a name="l00167"></a>00167                                         <span class="keywordflow">else</span>
<a name="l00168"></a>00168                                                 $KS_URL-&gt;redirect(<span class="stringliteral">&quot;/&quot;</span> . <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;URL_ident&#39;</span>] . <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00169"></a>00169                                 }
<a name="l00170"></a>00170                         }
<a name="l00171"></a>00171                         elseif(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;is_widget&#39;</span>]==1)
<a name="l00172"></a>00172                         {
<a name="l00173"></a>00173                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_module_hook_up.html#a2c94889f246d99a8917b547e48fb4d08">IncludeWidget</a>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>],<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;action&#39;</span>],<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;params&#39;</span>]);
<a name="l00174"></a>00174                         }
<a name="l00175"></a>00175                         <span class="keywordflow">else</span>
<a name="l00176"></a>00176                         {
<a name="l00177"></a>00177                                 <span class="comment">/* Производим инициализацию пользовательской части модуля */</span>
<a name="l00178"></a>00178                                 $module_parameters = <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;params&#39;</span>];
<a name="l00179"></a>00179                                 include ($module_main_file);
<a name="l00180"></a>00180                         }
<a name="l00181"></a>00181                 }
<a name="l00182"></a>00182                 <span class="keywordflow">else</span>
<a name="l00183"></a>00183                 {
<a name="l00184"></a>00184                         <span class="comment">/* Невозможно инициализировать модуль */</span>
<a name="l00185"></a>00185                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;MAIN_MODULE_NO_USER_PART&quot;</span>, 404);
<a name="l00186"></a>00186                 }
<a name="l00187"></a>00187         }
<a name="l00188"></a>00188 
<a name="l00193"></a><a class="code" href="class_c_module_hook_up.html#aa54add408184bddb6b792eae08b49a02">00193</a>         function <a class="code" href="class_c_module_hook_up.html#aa54add408184bddb6b792eae08b49a02">hook_up</a>($url_ident=<span class="stringliteral">&#39;default&#39;</span>)
<a name="l00194"></a>00194         {
<a name="l00195"></a>00195                 global <a class="code" href="catsubcat_2install_2install_8php.html#afc7cd28698e72d5bc152e5d74de0f54d">$ks_db</a>;
<a name="l00196"></a>00196                 <span class="keywordflow">if</span>( empty($url_ident) )
<a name="l00197"></a>00197                 {
<a name="l00198"></a>00198                         $url_ident = <span class="stringliteral">&#39;default&#39;</span>;
<a name="l00199"></a>00199                 }
<a name="l00200"></a>00200                 <a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>=array();
<a name="l00201"></a>00201                 <span class="keywordflow">if</span>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>=$this-&gt;<a class="code" href="class_c_object.html#aaa7edf39bf09d230ec2b32b95c138a9b">GetRecord</a>(array(<span class="stringliteral">&#39;URL_ident&#39;</span>=&gt;$url_ident,<span class="stringliteral">&#39;active&#39;</span>=&gt;1)))
<a name="l00202"></a>00202                         {
<a name="l00203"></a>00203                         <span class="keywordflow">if</span>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;include_global_template&#39;</span>] == 0)
<a name="l00204"></a>00204                                 <a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>[<span class="stringliteral">&#39;include_global_template&#39;</span>] = 0;
<a name="l00205"></a>00205                         <span class="keywordflow">try</span>
<a name="l00206"></a>00206                         {
<a name="l00207"></a>00207                                 $this-&gt;<a class="code" href="class_c_module_hook_up.html#a3729046d08c260692b7824af268e6fa7">IncludeModule</a>(<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>,<a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>);
<a name="l00208"></a>00208                         }
<a name="l00209"></a>00209                         <span class="keywordflow">catch</span> (<a class="code" href="class_c_module_error.html">CModuleError</a> $e)
<a name="l00210"></a>00210                         {
<a name="l00211"></a>00211                                 <span class="keywordflow">if</span>( $url_ident != <span class="stringliteral">&#39;default&#39;</span> )
<a name="l00212"></a>00212                                 {
<a name="l00213"></a>00213                                         <span class="comment">/* пробуем обработать дефолтовым */</span>
<a name="l00214"></a>00214                                         $this-&gt;<a class="code" href="class_c_module_hook_up.html#aa54add408184bddb6b792eae08b49a02">hook_up</a>();
<a name="l00215"></a>00215                                 }
<a name="l00216"></a>00216                                 <span class="keywordflow">else</span>
<a name="l00217"></a>00217                                 {
<a name="l00218"></a>00218                                         <span class="comment">/* это и есть дефолтовый, нужно отдать ошибку, что страница не найдена */</span>
<a name="l00219"></a>00219                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;SYSTEM_PAGE_NOT_FOUND&quot;</span>,404);
<a name="l00220"></a>00220                                 }
<a name="l00221"></a>00221                         }
<a name="l00222"></a>00222                         <span class="keywordflow">catch</span> (<a class="code" href="class_c_error.html">CError</a> $e)
<a name="l00223"></a>00223                         {
<a name="l00224"></a>00224                                 <span class="keywordflow">throw</span> $e;
<a name="l00225"></a>00225                         }
<a name="l00226"></a>00226                 }
<a name="l00227"></a>00227                 elseif($url_ident != <span class="stringliteral">&#39;default&#39;</span>)
<a name="l00228"></a>00228                 {
<a name="l00229"></a>00229                         <span class="comment">/* модуля нет, пробуем отработать дефолтовым */</span>
<a name="l00230"></a>00230                         <a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = $this-&gt;<a class="code" href="class_c_module_hook_up.html#aa54add408184bddb6b792eae08b49a02">hook_up</a>();
<a name="l00231"></a>00231                 }
<a name="l00232"></a>00232                 <span class="keywordflow">else</span>
<a name="l00233"></a>00233                 {
<a name="l00234"></a>00234                         <span class="comment">/* если нет дефолтового модуля, найти подходящий не удалось, отдаем 404 */</span>
<a name="l00235"></a>00235                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;SYSTEM_PAGE_NOT_FOUND&quot;</span>,404);
<a name="l00236"></a>00236                 }
<a name="l00237"></a>00237                 <span class="keywordflow">return</span> <a class="code" href="self_8simple__expanding__menu_8php.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239 
<a name="l00243"></a><a class="code" href="class_c_module_hook_up.html#ab51219e24ca190bc69934898367c52a1">00243</a>         function <a class="code" href="class_c_module_hook_up.html#ab51219e24ca190bc69934898367c52a1">GetTemplate</a>()
<a name="l00244"></a>00244         {
<a name="l00245"></a>00245                 <span class="keywordflow">return</span> $this-&gt;sTemplate;
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247 
<a name="l00251"></a><a class="code" href="class_c_module_hook_up.html#a39339face241a27f26bf2736f9d9b134">00251</a>         function <a class="code" href="class_c_module_hook_up.html#a39339face241a27f26bf2736f9d9b134">GetScheme</a>()
<a name="l00252"></a>00252         {
<a name="l00253"></a>00253                 <span class="keywordflow">return</span> $this-&gt;sScheme;
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 
<a name="l00265"></a><a class="code" href="class_c_module_hook_up.html#a2c94889f246d99a8917b547e48fb4d08">00265</a>         function <a class="code" href="class_c_module_hook_up.html#a2c94889f246d99a8917b547e48fb4d08">IncludeWidget</a>(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>,$params)
<a name="l00266"></a>00266         {
<a name="l00267"></a>00267                 global <a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>;
<a name="l00268"></a>00268                 <span class="keywordflow">if</span>(count($this-&gt;arWidgetStack)&gt;10) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;SYSTEM_WIDGET_TOO_NESTED&#39;</span>);
<a name="l00269"></a>00269                 <span class="keywordflow">try</span>
<a name="l00270"></a>00270                 {
<a name="l00271"></a>00271                         <span class="keywordflow">if</span>(!array_key_exists(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>,$this-&gt;arModules))
<a name="l00272"></a>00272                         {
<a name="l00273"></a>00273                                 <span class="comment">//Если модуль не загружен, пробуем его загрузить</span>
<a name="l00274"></a>00274                                 <span class="keywordflow">if</span>(!$this-&gt;<a class="code" href="class_c_module_hook_up.html#a2956153a176c9e8b2ed24489c3730280">InitModule</a>(<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>)) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;MAIN_THIS_NOT_MODULE&#39;</span>);
<a name="l00275"></a>00275                         }
<a name="l00276"></a>00276                         <a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>=$this-&gt;arModules[<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>];
<a name="l00277"></a>00277                         array_push($this-&gt;arWidgetStack,<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>.<span class="charliteral">&#39;_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>);
<a name="l00278"></a>00278                         <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&#39;smarty_function_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>))
<a name="l00279"></a>00279                         {
<a name="l00280"></a>00280                                 <span class="comment">//Если виджет не зарегистрирован, пробуем его найти и загрузить</span>
<a name="l00281"></a>00281                                 <span class="keywordflow">if</span>(file_exists(MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/widgets/function.&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>.<span class="stringliteral">&#39;.php&#39;</span>))
<a name="l00282"></a>00282                                 {
<a name="l00283"></a>00283                                         include_once(MODULES_DIR.<span class="charliteral">&#39;/&#39;</span>.<a class="code" href="interfaces_2install_2install_8php.html#a6eb2a618b0047ac12d0e20931b5e4986">$arModule</a>[<span class="stringliteral">&#39;directory&#39;</span>].<span class="stringliteral">&#39;/widgets/function.&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>.<span class="stringliteral">&#39;.php&#39;</span>);
<a name="l00284"></a>00284                                 }
<a name="l00285"></a>00285                                 <span class="keywordflow">else</span>
<a name="l00286"></a>00286                                 {
<a name="l00287"></a>00287                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;MAIN_WIDGET_NOT_REGISTERED&#39;</span>);
<a name="l00288"></a>00288                                 }
<a name="l00289"></a>00289                         }
<a name="l00290"></a>00290                         <a class="code" href="main_2fields_2common__list_2config_8php.html#ad6eb2e39b56b25e24d21f61f6a59fe02">$sResult</a>=call_user_func(<span class="stringliteral">&#39;smarty_function_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>,$params,$smarty);
<a name="l00291"></a>00291                 }
<a name="l00292"></a>00292                 <span class="keywordflow">catch</span>(<a class="code" href="class_c_error.html">CError</a> $e)
<a name="l00293"></a>00293                 {
<a name="l00294"></a>00294                         <span class="keywordflow">if</span>(array_pop($this-&gt;arWidgetStack)!=<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>.<span class="charliteral">&#39;_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;SYSTEM_WIDGET_RETURN_ERROR&#39;</span>,0,<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>.<span class="charliteral">&#39;_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>);
<a name="l00295"></a>00295                         <span class="keywordflow">throw</span> $e;
<a name="l00296"></a>00296                 }
<a name="l00297"></a>00297                 <span class="keywordflow">if</span>(array_pop($this-&gt;arWidgetStack)!=<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>.<span class="charliteral">&#39;_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;SYSTEM_WIDGET_RETURN_ERROR&#39;</span>,0,<a class="code" href="guestbook2_2main_8inc_8php.html#a878a05528effb15bb1a14775efc6e4ee">$module</a>.<span class="charliteral">&#39;_&#39;</span>.<a class="code" href="smilies_8php.html#aa698a3e72116e8e778be0e95d908ee30">$action</a>);
<a name="l00298"></a>00298                 <span class="keywordflow">return</span> <a class="code" href="main_2fields_2common__list_2config_8php.html#ad6eb2e39b56b25e24d21f61f6a59fe02">$sResult</a>;
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300 
<a name="l00304"></a><a class="code" href="class_c_module_hook_up.html#aa10f04b0bb441fc7eed5bb92e19ae0cf">00304</a>         function <a class="code" href="class_c_module_hook_up.html#aa10f04b0bb441fc7eed5bb92e19ae0cf">AutoInit</a>()
<a name="l00305"></a>00305         {
<a name="l00306"></a>00306                 global <a class="code" href="catsubcat_2install_2install_8php.html#afc7cd28698e72d5bc152e5d74de0f54d">$ks_db</a>;
<a name="l00307"></a>00307                 $res_sel_modules_to_include = $ks_db-&gt;query(<span class="stringliteral">&quot;</span>
<a name="l00308"></a>00308 <span class="stringliteral">                        SELECT  *</span>
<a name="l00309"></a>00309 <span class="stringliteral">                        FROM    `&quot;</span>.PREFIX.<span class="stringliteral">&quot;main_modules`</span>
<a name="l00310"></a>00310 <span class="stringliteral">                        WHERE   (`active` = &#39;1&#39;) AND (`hook_up`=&#39;1&#39;)</span>
<a name="l00311"></a>00311 <span class="stringliteral">                                ORDER BY `orderation` ASC&quot;</span>);
<a name="l00312"></a>00312                 <span class="keywordflow">while</span> ($r_sel_modules_to_include = $ks_db-&gt;get_array($res_sel_modules_to_include))
<a name="l00313"></a>00313                 {
<a name="l00314"></a>00314                         <span class="keywordflow">if</span>(!$this-&gt;<a class="code" href="class_c_module_hook_up.html#a2956153a176c9e8b2ed24489c3730280">InitModule</a>($r_sel_modules_to_include)) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&#39;SYSTEM_MODULE_INIT_ERROR&#39;</span>,0,$r_sel_modules_to_include[<span class="stringliteral">&#39;directory&#39;</span>]);
<a name="l00315"></a>00315                 }
<a name="l00316"></a>00316                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 
<a name="l00324"></a><a class="code" href="class_c_module_hook_up.html#a082d4a327408ab750c53ea44416c4f08">00324</a>         function <a class="code" href="class_c_module_hook_up.html#a082d4a327408ab750c53ea44416c4f08">RenderTemplate</a>(<a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>,$widget,$globalTemplate=<span class="stringliteral">&#39;&#39;</span>,$localTemplate=<span class="stringliteral">&#39;&#39;</span>)
<a name="l00325"></a>00325         {
<a name="l00326"></a>00326                 global <a class="code" href="catsubcat_2main_8inc_8php.html#a69db94368c3d1c30bc71073322cfbf29">$global_template</a>;
<a name="l00327"></a>00327                 <span class="comment">//Формируем первую часть пути (глобальный шаблон)</span>
<a name="l00328"></a>00328                 <a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>=(strlen($globalTemplate)==0)?$global_template:$globalTemplate;
<a name="l00329"></a>00329                 <span class="comment">//Добавляем путь к шаблону</span>
<a name="l00330"></a>00330                 $sLocalTemplate=$widget.$localTemplate.<span class="stringliteral">&#39;.tpl&#39;</span>;  <span class="comment">// шаблон по умолчанию</span>
<a name="l00331"></a>00331                 $sJsFile=$widget.$localTemplate.<span class="stringliteral">&#39;.js&#39;</span>;
<a name="l00332"></a>00332                 <span class="comment">//Проверяем наличие шаблона</span>
<a name="l00333"></a>00333                 <span class="keywordflow">if</span>(<a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>-&gt;template_exists(<a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>.$sLocalTemplate))
<a name="l00334"></a>00334                 {
<a name="l00335"></a>00335                         <a class="code" href="main_2fields_2common__list_2config_8php.html#ad6eb2e39b56b25e24d21f61f6a59fe02">$sResult</a>=<a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>-&gt;fetch(<a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>.$sLocalTemplate);
<a name="l00336"></a>00336                 }
<a name="l00337"></a>00337                 <span class="keywordflow">else</span>
<a name="l00338"></a>00338                 {
<a name="l00339"></a>00339                         <span class="keywordflow">if</span>(<a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>-&gt;template_exists(<span class="stringliteral">&#39;.default&#39;</span>.$sLocalTemplate))
<a name="l00340"></a>00340                         {
<a name="l00341"></a>00341                                 <a class="code" href="main_2fields_2common__list_2config_8php.html#ad6eb2e39b56b25e24d21f61f6a59fe02">$sResult</a>=<a class="code" href="catsubcat_2main_8inc_8php.html#adcc61d2025f18e203a0e5e4d29f93014">$smarty</a>-&gt;fetch(<span class="stringliteral">&#39;.default&#39;</span>.$sLocalTemplate);
<a name="l00342"></a>00342                         }
<a name="l00343"></a>00343                         <span class="keywordflow">else</span>
<a name="l00344"></a>00344                                 <span class="comment">//Eсли шаблон так и не нашли отдаем ошибку</span>
<a name="l00345"></a>00345                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_c_error.html">CError</a>(<span class="stringliteral">&quot;MAIN_TEMPLATE_ERROR&quot;</span>,0,<a class="code" href="class_c_module_hook_up.html#a941e02ffba607e81a858f85bd11e00c8">$sTemplate</a>.$sLocalTemplate);
<a name="l00346"></a>00346                 }
<a name="l00347"></a>00347                 <span class="keywordflow">if</span>(!file_exists(ROOT_DIR.JS_DIR.$sJsFile))
<a name="l00348"></a>00348                 {
<a name="l00349"></a>00349                         <span class="keywordflow">if</span>(file_exists(ROOT_DIR.JS_DIR.$widget.<span class="stringliteral">&#39;.js&#39;</span>))
<a name="l00350"></a>00350                         {
<a name="l00351"></a>00351                                 $this-&gt;<a class="code" href="class_c_module_managment.html#aa337f89018f666b86d17ee00a538041f">UseJavaScript</a>($widget.<span class="stringliteral">&#39;.js&#39;</span>,12);
<a name="l00352"></a>00352                         }
<a name="l00353"></a>00353                 }
<a name="l00354"></a>00354                 <span class="keywordflow">else</span>
<a name="l00355"></a>00355                 {
<a name="l00356"></a>00356                         $this-&gt;<a class="code" href="class_c_module_managment.html#aa337f89018f666b86d17ee00a538041f">UseJavaScript</a>($sJsFile,13);
<a name="l00357"></a>00357                 }
<a name="l00358"></a>00358                 <span class="keywordflow">return</span> <a class="code" href="main_2fields_2common__list_2config_8php.html#ad6eb2e39b56b25e24d21f61f6a59fe02">$sResult</a>;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Документация по KS-CMS. Последние изменения: Wed Mar 2 2011 17:46:19. Создано системой&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
